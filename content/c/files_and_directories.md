+++
title = "Files And Directories"
date = 2019-08-28T09:06:02+08:00
draft = true
tags = ["tags"]
categories = ["c"]
+++

# 文件和目录

在描述操作文件和文件夹的系统调用和库之前，有必要先了解 UNIX 的文件系统。

## 普通文件

文件包含用户放置在其中的任何信息。与其他操作系统不同，不对常规文件施加格式（例如，顺序，随机访问等）。一个常规文件被简单地认为是字节序列，这些字节可以被程序以任何想要的方式读写。某些程序期望一个文件有指定的格式。例如汇编器生成特定格式的目标文件，加载期望的格式作为输入。需要注意的重要特征是文件结构由访问它们的程序控制，而不是由操作系统。

## 目录

目录提供一个文件名字和文件本身的映射，从而在整个文件系统引入一个结构。一个目录包含许多文件，也可以包含子目录，子目录下也可以包含很多文件。一个目录被读取时和一个普通文件表现地一样，不允许被没有权限的程序写入。

操作系统管理一些目录给自己使用。其中一个是 `root` 目录。文件系统中的所有文件都可以从根目录开始的文件路径被追踪到。

当为系统指定文件名时，它可能采用路径名的形式，这是由斜杠分隔的文件名序列。任何文件名最后一个斜杠后面必须是目录的名称。如果序列以斜杠开头，那搜索从根路径开始，否则从程序的当前目录开始。`/` 代表 root 目录，并且空文件名（例如，/ a / b /）指的是其名称前面的目录。 二斜杠（“//”）被解释为单斜杠。

每个目录至少有两个入口，`.` 在每个目录中指向目录本身。因此一个程序可以在不知道目录名的情况下通过 `.` 读取当前目录。为了方便，`..` 指向当前目录的父级目录。如果当前目录是 `/root`，那么 `..` 还是指向 `/root`。

## 特殊文件

特殊文件是 UNIX 文件系统中最不寻常的方面之一。每一个 I/O 设备（硬盘，磁带，终端等）都至少关联一个这种文件。在程序中，特殊文件和其他任何文件看起来差不多，但请求读写会导致关联设备的激活。例如，一个程序想要在磁带上写数据可能会打开文件 `/dev/mt`。在这个文件上的读写请求会导致磁带的移动和数据的读写在合适的位置。由于 UNIX 的长期规定，特殊文件的入口驻留在 `/dev` 目录，但操作系统并没有强制要求这一点。

## 可移除文件系统

整个文件系统层级存储在同一个设备中是没有必要的，虽然文件系统的根目录一直驻留在同一个地方（以便于系统启动时能定位到）。`mount` 系统调用（也和用户命令有关）接收两个参数：一个和存储卷关联的特殊文件的名字，这个存储卷应该有独立的文件系统包含它自己的目录层级；另一个参数是一个已存在的普通文件或目录。这个调用的效果是用特殊文件的目录树替换文件树的叶子节点。所有到普通文件或目录的引用会指向新设备中的树。

## 设备编号

每一个系统中的特殊文件和两个设备编号关联。主要设备编号通知操作系统在引用这个文件名时应该使用那种设备类型。每一种设备类型在系统中都有对应的一段代码块称为设备驱动工作于对应的设备。次要设备编号传递给设备驱动，用于检测哪种物理设备被使用了。例如，次要设备编号用于在多驱动控制器上检测哪个磁盘驱动应该被访问，哪个磁盘驱动的分区应该被使用，或者一个磁带驱动应该倒带当请求完成的时候。几个设备可能有相同的主要设备编号（如相同类型的磁盘驱动），但他们的次要设备编号都是不同的。

## I-Numbers, I-List 和 I-Nodes

目录提供了文件名和文件本身的映射。一个目录由一系列结构体组成。每个结构体包含文件名和指向文件本身的指针。这个指针是一个整数称为 i-number（index number）。当文件被访问时，它的 i-number 被用作存放文件入口（i-node）的系统表（i-list）的索引。i-node 包含一个文件的描述：

* 文件拥有者是哪个用户和他的组 id
* 文件的保护
* 文件内容的物理磁盘地址
* 文件的大小
* 文件的创建时间，上次使用时间，和上次修改时间
* 指向文件的链接数量，在目录中出现的次数
* 一个表明文件类型（目录，常规文件或特殊文件）的标签

系统为每个挂载的目录树维护一个单独的 i-list，因此系统中的多个文件可能有相同的 i-number。通过和特殊文件关联的主要和次要设备编号和 i-number 一起，每个文件都可以被唯一确定。

### 硬链接

通过链接，可以让多个文件名指向同一个文件。文件系统以新的名字和 i-number 为目录创建一个新的入口来建立链接。这种链接通常被称为硬链接。注意因为 i-number 是不一样的，所以没法通过 i-number 来链接。一个文件不管有多少个硬链接，都只有一个 i-node 来描述改文件。

### 符号链接

符号链接表现地像是一个指向另一个文件的指针。因为在符号链接中不涉及 i-numbers，所以可以跨文件系统创建符号链接。这使得符号链接比硬链接更加灵活。

## 判断文件权限

`access` 函数可用于判断文件对于程序是否可以访问。它接受两个参数：第一个参数是文件名，第二个参数是一个整数，用于表明要检测哪种权限，可以是以下几种在 `sys/file.h` 中定义的常量：

* `F_OK` 表明文件是否存在
* `X_OK` 表明文件是否可执行
* `W_OK` 表明文件是否可写
* `R_OK` 表明文件是否可读

这些常量可以通过或运算来连接在一起来表明检测多个权限。如果有权限，函数返回0，否则返回-1并且设置`errno`。这个方法用于检查特定的权限是很有用的。但是它只能告诉你是否有某个权限，不能告诉你有哪些权限。

## 从 I-Node 获取信息

用于获取在 i-node 中存储的数据的系统调用是 `stat` 函数。它接收两个参数：文件名字符串和指向 `stat` 结构体的指针。有一个另外的函数 `fstat` 接收一个文件描述符而不是文件名字符串。`lstat` 函数用于获取符号链接文件本身的信息，`stat` 会获取符号链接指向的文件的信息。所有这些调用成功时返回0，出错时返回-1，并且会设置 `errno`。

`stat` 的数据结构如下所示：

```c
struct stat {

    dev_t     st_dev;
    ino_t     st_ino;
    u_short   st_mode;
    short     st_nlink;
    short     st_uid;
    short     st_gid;
    dev_t     st_rdev;
    off_t     st_size;
    time_t    st_atime;
    time_t    st_mtime;
    time_t    st_ctime;
};
```

* `st_dev`: i-node 存储的主要设备编号和次要设备编号
* `st_ino`: i-node 编号
* `st_mode`: 位加密的文件类型和权限集合
* `st_nlink`: 文件拥有的硬链接数量，包括文件本身，因此最小为1
* `st_uid`: 文件拥有者的 uid
* `st_gid`: 文件的 gid
* `st_rdev`: 设备的类型如果文件是特殊文件
* `st_size`: 文件大小字节数
* `st_atime`: 文件上一次被访问的时间，以标准 unix 时间戳的形式存储
* `st_mtime`: 文件上一次被修改写入的时间
* `st_ctime`: 文件上一次 i-node 改变的时间。比如跨文件系统移动会改变 i-node。

## 读取目录

如之前所说，一个目录只是一个包含 i-number/文件名对的特殊文件。一个目录包含一个 `direct` 类型的结构体，
