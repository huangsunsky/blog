<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="description" content=Aloha!&#32;Welcome&#32;to&#32;cheon&#39;s&#32;blog.>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon" sizes= "76x76" href=https://www.cheon.site/blog/img/apple-touch-icon.png>
    <link rel="icon" href=https://www.cheon.site/blog/img/pen.svg>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/global.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/nav.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/header.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/index.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/list.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/single.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/footer.css>
    
    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel="stylesheet">
    
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <title>cheon&#39;s blog</title>

</head>
<body><section id="header">
    <ul id="menus">
    
    <li class="menu"><a href="https://www.cheon.site"><span>Home</span></a></li>
    
    <li class="menu"><a href="https://www.cheon.site/blog/categories"><span>Categories</span></a></li>
    
    <li class="menu"><a href="https://www.cheon.site/blog/tags"><span>Tags</span></a></li>
    
    <li class="menu"><a href="https://github.com/number317"><span>Projects</span></a></li>
    
    </ul>
    <h1 id="title"><a href="https://www.cheon.site/blog/">cheon&#39;s blog</a></h1>
</section>
<ul class="nav">






<li>
    »
    <a href="https://www.cheon.site/blog/">
    
    cheon&#39;s blog
    
    </a>
</li>


<li>
    »
    <a href="https://www.cheon.site/blog/struct/">
    
    struct
    
    
    </a>
</li>


<li class="active">
    »
    <a href="https://www.cheon.site/blog/struct/k8s_cluster_deploy/">
    
    K8s Cluster Deploy
    
    </a>
</li>

</ul>

<div>
<section id="main">
  <h1>K8s Cluster Deploy</h1>
  <time>Last updated Fri Jun 14, 2019</time>
  <div>
      <article id="content">
          

<h1 id="vagrant-kubernetes-集群部署">vagrant kubernetes 集群部署</h1>

<h2 id="集群说明">集群说明</h2>

<p>集群共有四个节点，一个master节点，四个子节点，其中一个节点即是master节点，也是node节点，系统均为centos-7.2。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">k8s-node1      192.168.12.81       master, node
k8s-node2      192.168.12.82       node
k8s-node3      192.168.12.83       node
k8s-node4      192.168.12.84       node</code></pre></div>
<h2 id="vagrant-配置">vagrant 配置</h2>

<p>vagrant 的 box 可选用 bento/centos-7.2:</p>

<p><details>
<summary>Vagrantfile</summary></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#888;font-style:italic"># -*- mode: ruby -*-</span>
<span style="color:#888;font-style:italic"># vi: set ft=ruby :</span>

<span style="color:#888;font-style:italic"># All Vagrant configuration is done below. The &#34;2&#34; in Vagrant.configure</span>
<span style="color:#888;font-style:italic"># configures the configuration version (we support older styles for</span>
<span style="color:#888;font-style:italic"># backwards compatibility). Please don&#39;t change it unless you know what</span>
<span style="color:#888;font-style:italic"># you&#39;re doing.</span>
<span style="color:#666;font-weight:bold;font-style:italic">Vagrant</span>.configure(<span style="color:#666;font-style:italic">&#34;2&#34;</span>) <span style="font-weight:bold">do</span> |config|
    (1..4).each <span style="font-weight:bold">do</span> |i|
        config.vm.define <span style="color:#666;font-style:italic">&#34;k8s-node</span><span style="color:#666;font-style:italic">#{</span>i<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">&#34;</span> <span style="font-weight:bold">do</span> |node|
            file_to_disk = <span style="color:#666;font-style:italic">&#34;tmp/k8s_node</span><span style="color:#666;font-style:italic">#{</span>i<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">_disk.vdi&#34;</span>
            node.vm.box = <span style="color:#666;font-style:italic">&#34;centos-7.2&#34;</span>
            node.vm.hostname = <span style="color:#666;font-style:italic">&#34;k8s-node</span><span style="color:#666;font-style:italic">#{</span>i<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">&#34;</span>
            n = 80 +i
            node.vm.network <span style="color:#666;font-style:italic">&#34;private_network&#34;</span>, <span style="color:#666;font-style:italic">ip</span>: <span style="color:#666;font-style:italic">&#34;192.168.12.</span><span style="color:#666;font-style:italic">#{</span>n<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">&#34;</span>
            node.vm.provider <span style="color:#666;font-style:italic">&#34;virtualbox&#34;</span> <span style="font-weight:bold">do</span> |vb|
                vb.name = <span style="color:#666;font-style:italic">&#34;k8s-node</span><span style="color:#666;font-style:italic">#{</span>i<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">&#34;</span>
                vb.cpus = 2
                vb.memory = 1024
            <span style="font-weight:bold">end</span>
            node.vm.provision <span style="color:#666;font-style:italic">&#34;ansible&#34;</span> <span style="font-weight:bold">do</span> |ansible|
                ansible.playbook = <span style="color:#666;font-style:italic">&#34;playbook.yml&#34;</span>
                ansible.groups = {
                <span style="color:#666;font-style:italic">&#34;master&#34;</span> =&gt; [<span style="color:#666;font-style:italic">&#34;k8s-node1&#34;</span>],
                <span style="color:#666;font-style:italic">&#34;nodes&#34;</span> =&gt; (1..4).map {|j| <span style="color:#666;font-style:italic">&#34;k8s-node</span><span style="color:#666;font-style:italic">#{</span>j<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">&#34;</span>},
            }
            <span style="font-weight:bold">end</span>
        <span style="font-weight:bold">end</span>
    <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p></details></p>

<p>其中的 playbook.yml 主要用于一些软件的安装和简单的配置，内容如下：</p>

<p><details>
<summary>playbook</summary></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">---
- hosts: all
  tasks:
    - name: install epel-release
      yum:
        name: epel-release
        state: latest
      become: <span style="font-weight:bold">true</span>
    - name: stop &amp; disable firewall
      shell: systemctl stop firewalld <span style="color:#888;font-weight:bold">&amp;&amp;</span> systemctl disable firewalld
      become: <span style="font-weight:bold">true</span>
- hosts: master
  tasks:
    - name: master install softwares
      yum:
        name={{item}}
        state=latest
      with_items:
        - etcd
        - kubernetes-master
      become: <span style="font-weight:bold">true</span>
- hosts: nodes
  tasks:
    - name: nodes install softwares
      yum:
        name={{item}}
        state=latest
      with_items:
        - vim
        - bash-completion
        - docker
        - flannel
        - kubernetes-node
      become: <span style="font-weight:bold">true</span></code></pre></div>
<p></details></p>

<p>上面的 playbook 定义了一些任务，分别是关闭了所有虚拟机的防火墙；在 master 节点上安装了 etcd，kubernetes-master 等软件；在 node 节点上安装了 vim，bash-completion，docker，flannel，kubernetes-node 等软件。运行<code>vagrant up</code>启动定义好的四个虚拟机。</p>

<h1 id="master-节点配置">master 节点配置</h1>

<p>执行<code>vagrant ssh k8s-node1</code>登录到 master 节点上，执行<code>sudo su</code>切换到 root 用户</p>

<ol>
<li><p>编辑<code>/etc/etcd/etcd.conf</code>文件:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">ETCD_NAME=master
ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;
ETCD_LISTEN_CLIENT_URLS=&#34;http://0.0.0.0:2379&#34;
ETCD_ADVERTISE_CLIENT_URLS=&#34;http://192.168.12.81:2379&#34;</code></pre></div>
<ol>
<li>编辑<code>/etc/kubernetes/apiserver</code>文件:</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">KUBE_API_ADDRESS=&#34;--insecure-bind-address=0.0.0.0&#34;
KUBE_API_PORT=&#34;--port=8080&#34;
KUBELET_PORT=&#34;--kubelet-port=10250&#34;
KUBE_ETCD_SERVERS=&#34;--etcd-servers=http://127.0.0.1:2379&#34;
KUBE_SERVICE_ADDRESSES=&#34;--service-cluster-ip-range=10.254.0.0/16&#34;
KUBE_ADMISSION_CONTROL=&#34;--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota&#34;
KUBE_API_ARGS=&#34;&#34;</code></pre></div></li>

<li><p>启动 etcd、kube-apiserver、kube-controller-manager、kube-scheduler、docker 等服务，并设置开机启动。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="font-weight:bold">for</span> service in etcd kube-apiserver kube-controller-manager kube-scheduler docker; <span style="font-weight:bold">do</span> systemctl restart <span style="color:#666;font-weight:bold;font-style:italic">$service</span>;systemctl <span style="font-weight:bold;font-style:italic">enable</span> <span style="color:#666;font-weight:bold;font-style:italic">$service</span>;systemctl status <span style="color:#666;font-weight:bold;font-style:italic">$service</span> ; <span style="font-weight:bold">done</span></code></pre></div>
<h1 id="node-节点配置">node 节点配置</h1>

<p>登录到各个 node 节点上（包括即作为 master 也作为 node 的 k8s-node1 节点），执行以下操作。</p>

<ol>
<li>为 flannel 网络指定 etcd 服务，修改<code>/etc/sysconfig/flanneld</code>文件:</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">FLANNEL_ETCD=&#34;http://192.168.12.81:2379&#34;
FLANNEL_ETCD_KEY=&#34;/atomic.io/network&#34;
FLANNEL_OPTIONS=&#34;--iface=enp0s8&#34;</code></pre></div>
<p>etcd和flannel用于配置容器的跨主机通信，具体见<a href="./struct/etcd--flannel/">etcd &amp; flannel</a></p></li>

<li><p>修改<code>/etc/kubernetes/config</code>文件:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">KUBE_LOGTOSTDERR=&#34;--logtostderr=true&#34;
KUBE_LOG_LEVEL=&#34;--v=0&#34;
KUBE_ALLOW_PRIV=&#34;--allow-privileged=false&#34;
KUBE_MASTER=&#34;--master=http://192.168.12.81:8080&#34;</code></pre></div>
<ol>
<li>修改kubelet配置文件<code>/etc/kubernetes/kubelet</code>:</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-conf" data-lang="conf">KUBELET_ADDRESS=&#34;--address=0.0.0.0&#34;
KUBELET_PORT=&#34;--port=10250&#34;
#这里的KUBELET_HOSTNAME是该node的ip地址
KUBELET_HOSTNAME=&#34;--hostname-override=192.168.12.82&#34;
KUBELET_API_SERVER=&#34;--api-servers=http://192.168.12.81:8080&#34;
KUBELET_POD_INFRA_CONTAINER=&#34;--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/architect/pod-infrastructure&#34;
KUBELET_ARGS=&#34;&#34;</code></pre></div>
<p>这里的<code>KUBELET_POD_INFRA_CONTAINER</code>默认的镜像需要翻墙，这里改成了阿里云的镜像，便于下载。</p></li>

<li><p>在所有 Node节点上启动 kube-proxy,kubelet,docker,flanneld 等服务，并设置开机启动。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="font-weight:bold">for</span> service in kube-proxy kubelet docker flanneld;<span style="font-weight:bold">do</span> systemctl restart <span style="color:#666;font-weight:bold;font-style:italic">$service</span>;systemctl <span style="font-weight:bold;font-style:italic">enable</span> <span style="color:#666;font-weight:bold;font-style:italic">$service</span>;systemctl status <span style="color:#666;font-weight:bold;font-style:italic">$service</span>; <span style="font-weight:bold">done</span></code></pre></div>
<h1 id="查看集群状态">查看集群状态</h1>

<p>在master节点 k8s-node1 上执行<code>kubectl get nodes</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get nodes
NAME            STATUS    AGE
192.168.12.81   Ready     22h
192.168.12.82   Ready     22h
192.168.12.83   Ready     22h
192.168.12.84   Ready     22h</code></pre></div></li>
</ol>

<p>看到节点的状态是 ready 说明集群已经搭建成功。</p>

<h1 id="配置dashboard">配置dashboard</h1>

<p>部署文件 dashboard.yml 如下：</p>

<p><details>
<summary>dashboard deploy</summary></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: kubernetes-dashboard-v1.7.1
  namespace: kube-system
spec:
  replicas: 1
  template:
    metadata:
      labels:
        k8s-app: kubernetes-dashboard
        version: v1.7.1
        kubernetes.io/cluster-service: <span style="color:#666;font-style:italic">&#34;true&#34;</span>
    spec:
      containers:
      - name: kubernetes-dashboard
        image: registry.cn-hangzhou.aliyuncs.com/google-containers/kubernetes-dashboard-amd64
        resources:
          limits:
            cpu: 100m
            memory: 50Mi
          requests:
            cpu: 100m
            memory: 50Mi
        ports:
        - containerPort: 9090
        args:
         <span style="color:#666;font-style:italic">-  --apiserver-host=http://192.168.12.81:8080</span>
        livenessProbe:
          httpGet:
            path: /
            port: 9090
          initialDelaySeconds: 30
          timeoutSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: kubernetes-dashboard
  namespace: kube-system
  labels:
    k8s-app: kubernetes-dashboard
    kubernetes.io/cluster-service: <span style="color:#666;font-style:italic">&#34;true&#34;</span>
spec:
  selector:
    k8s-app: kubernetes-dashboard
  ports:
  - port: 80
    targetPort: 9090</code></pre></div>
<p></details></p>

<p>在master节点192.168.12.81上执行</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f dashboard.yml</code></pre></div>
<p>等待 pod 部署好后，访问<code>192.168.12.81:8080/ui</code>即可看到 dashboard 的界面。</p>

      </article>
  </div>
</section>

<aside>
    <h4 id="signature">
        Mon Dec 4, 2017
        
            cheon
        
    </h4>
    
    
    <ul class="tags">
      
        <li> <a href="https://www.cheon.site/blog/tags/k8s">k8s</a> </li>
      
    </ul>
    
    <ul class="related">
        
        <li><a class="previous" href="https://www.cheon.site/blog/struct/maven_nexus/"> Maven &amp; Nexus</a></li>
        
        
        <li><a class="next" href="https://www.cheon.site/blog/struct/fluentd_config/"> Fluentd Config</a></li>
        
    </ul>
</aside>

        </div><section id="footer">

<div id="author">
    <h2>About Author</h2>
    <hr>
    <img src=https://www.cheon.site/images/author.jpg></img>
    <p>Life is dance we all have to do.</p>
</div>
<ul id="link">
    <li><a href=https://github.com/number317/aloha.git target="_blank"><i class="fa fa-github" alt="github"></i></a></li>
    <li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target="_blank"><i class="fa fa-envelope" alt="email"></i></a></li>
    <li id="wechat"><i class="fa fa-wechat"></i></li>
    <img class="qrcode" src=https://www.cheon.site/images/wechat.jpg>
</ul>
</section>
</body>
</html>
