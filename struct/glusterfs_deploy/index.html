<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="description" content=Aloha!&#32;Welcome&#32;to&#32;cheon&#39;s&#32;blog.>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="apple-touch-icon" sizes= "76x76" href=https://www.cheon.site/blog/img/apple-touch-icon.png>
    <link rel="icon" href=https://www.cheon.site/blog/img/pen.svg>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/global.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/nav.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/header.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/index.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/list.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/single.css>
    <link rel="stylesheet" href=https://www.cheon.site/blog/css/footer.css>
    
    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Noto+Sans+SC|Old+Standard+TT&display=swap" rel="stylesheet">
    
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <title>cheon&#39;s blog</title>

</head>
<body><section id="header">
    <ul id="menus">
    
    <li class="menu"><a href="https://www.cheon.site"><span>Home</span></a></li>
    
    <li class="menu"><a href="https://www.cheon.site/blog/categories"><span>Categories</span></a></li>
    
    <li class="menu"><a href="https://www.cheon.site/blog/tags"><span>Tags</span></a></li>
    
    <li class="menu"><a href="https://github.com/number317"><span>Projects</span></a></li>
    
    </ul>
    <h1 id="title"><a href="https://www.cheon.site/blog/">cheon&#39;s blog</a></h1>
</section>
<ul class="nav">






<li>
    »
    <a href="https://www.cheon.site/blog/">
    
    cheon&#39;s blog
    
    </a>
</li>


<li>
    »
    <a href="https://www.cheon.site/blog/struct/">
    
    struct
    
    
    </a>
</li>


<li class="active">
    »
    <a href="https://www.cheon.site/blog/struct/glusterfs_deploy/">
    
    Glusterfs Deploy
    
    </a>
</li>

</ul>

<div>
<section id="main">
  <h1>Glusterfs Deploy</h1>
  <time>Last updated Fri Jun 14, 2019</time>
  <div>
      <article id="content">
          

<h1 id="glusterfs-centos-部署">glusterfs centos 部署</h1>

<p>GlusterFS是一个开源的分布式文件系统，这里部署它主要为了解决文件存储的单点问题。</p>

<h2 id="虚拟机配置">虚拟机配置</h2>

<p>此处采用vagrant部署centos的虚拟机三台，box可以采用bento/centos7.2，配置文件如下：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#666;font-weight:bold;font-style:italic">Vagrant</span>.configure(<span style="color:#666;font-style:italic">&#34;2&#34;</span>) <span style="font-weight:bold">do</span> |config|
    (1..3).each <span style="font-weight:bold">do</span> |i|
        config.vm.define <span style="color:#666;font-style:italic">&#34;gluster-node</span><span style="color:#666;font-style:italic">#{</span>i<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">&#34;</span> <span style="font-weight:bold">do</span> |node|
            file_to_disk = <span style="color:#666;font-style:italic">&#34;tmp/gluster_node</span><span style="color:#666;font-style:italic">#{</span>i<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">_disk.vdi&#34;</span>
            node.vm.box = <span style="color:#666;font-style:italic">&#34;centos-7.2&#34;</span>
            node.vm.hostname = <span style="color:#666;font-style:italic">&#34;gluster-node</span><span style="color:#666;font-style:italic">#{</span>i<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">&#34;</span>
            n = 100 +i
            node.vm.network <span style="color:#666;font-style:italic">&#34;private_network&#34;</span>, <span style="color:#666;font-style:italic">ip</span>: <span style="color:#666;font-style:italic">&#34;192.168.12.</span><span style="color:#666;font-style:italic">#{</span>n<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">&#34;</span>
            node.vm.provider <span style="color:#666;font-style:italic">&#34;virtualbox&#34;</span> <span style="font-weight:bold">do</span> |vb|
                <span style="font-weight:bold">unless</span> <span style="color:#666;font-weight:bold;font-style:italic">File</span>.exist?(file_to_disk)
                    vb.customize [<span style="color:#666;font-style:italic">&#39;createhd&#39;</span>, <span style="color:#666;font-style:italic">&#39;--filename&#39;</span>, file_to_disk, <span style="color:#666;font-style:italic">&#39;--size&#39;</span>, 10 * 1024]
                    vb.customize [<span style="color:#666;font-style:italic">&#39;storageattach&#39;</span>, <span style="color:#666;font-style:italic">:id</span>, <span style="color:#666;font-style:italic">&#39;--storagectl&#39;</span>, <span style="color:#666;font-style:italic">&#39;SATA Controller&#39;</span>, <span style="color:#666;font-style:italic">&#39;--port&#39;</span>, 1, <span style="color:#666;font-style:italic">&#39;--device&#39;</span>, 0, <span style="color:#666;font-style:italic">&#39;--type&#39;</span>, <span style="color:#666;font-style:italic">&#39;hdd&#39;</span>, <span style="color:#666;font-style:italic">&#39;--medium&#39;</span>, file_to_disk]
                <span style="font-weight:bold">end</span>
                vb.name = <span style="color:#666;font-style:italic">&#34;gluster-node</span><span style="color:#666;font-style:italic">#{</span>i<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">&#34;</span>
                vb.cpus = 1
                vb.memory = 1024
            <span style="font-weight:bold">end</span>
        <span style="font-weight:bold">end</span>
    <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<p>该配置文件根据官方<a href="http://docs.gluster.org/en/latest/Quick-Start-Guide/Quickstart/">quick start</a>文档，为虚拟机配置了第二磁盘，用于GlusterFS存储，大小为10G。</p>

<h2 id="格式化并挂载分区">格式化并挂载分区</h2>

<p>以下步骤需要在三台虚拟机上都执行一遍，为了方便操作，切换到root用户：</p>

<ol>
<li><p>为磁盘创建分区</p>

<p>通过<code>vagrant ssh</code>命令进入到任意一个节点，执行<code>lsblk</code>命令应该能查看到类似以下输出：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># lsblk</span>
NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda               8:0    0   40G  0 disk
├─sda1            8:1    0  500M  0 part /boot
└─sda2            8:2    0 39.5G  0 part
  ├─centos-root 253:0    0 37.5G  0 lvm  /
  └─centos-swap 253:1    0    2G  0 lvm  [SWAP]
sdb               8:16   0   10G  0 disk</code></pre></div>
<p>可以看到第二块磁盘sdb没有分区，我们应该先分区:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># parted /dev/sdb</span>
GNU Parted 3.1
Using /dev/sdb
Welcome to GNU Parted! Type <span style="color:#666;font-style:italic">&#39;help&#39;</span> to view a list of commands.
(parted) mklabel gpt
(parted) mkpart primary xfs 1M 100%
(parted) quit
Information: You may need to update /etc/fstab.</code></pre></div>
<p>这里使用<code>parted</code>命令进行操作，为sdb磁盘创建了gpt分区表，并将所有空间分给了xfs格式的主分区，执行完以上操作后再次执行<code>lsblk</code>命令应该能查看到类似以下输出：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># lsblk</span>
NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda               8:0    0   40G  0 disk
├─sda1            8:1    0  500M  0 part /boot
└─sda2            8:2    0 39.5G  0 part
  ├─centos-root 253:0    0 37.5G  0 lvm  /
  └─centos-swap 253:1    0    2G  0 lvm  [SWAP]
sdb               8:16   0   10G  0 disk
└─sdb1            8:17   0   10G  0 part</code></pre></div>
<ol>
<li>格式化并挂载新建分区</li>
</ol>

<p>将分区格式化为xfs格式：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># mkfs.xfs -i size=512 /dev/sdb1</span>
meta-data=/dev/sdb1              <span style="color:#666;font-weight:bold;font-style:italic">isize</span>=512    <span style="color:#666;font-weight:bold;font-style:italic">agcount</span>=4, <span style="color:#666;font-weight:bold;font-style:italic">agsize</span>=655232 <span style="color:#666;font-weight:bold;font-style:italic">blks</span>
         =                       <span style="color:#666;font-weight:bold;font-style:italic">sectsz</span>=512   <span style="color:#666;font-weight:bold;font-style:italic">attr</span>=2, <span style="color:#666;font-weight:bold;font-style:italic">projid32bit</span>=<span style="color:#666;font-weight:bold;font-style:italic">1</span>
         =                       <span style="color:#666;font-weight:bold;font-style:italic">crc</span>=0        <span style="color:#666;font-weight:bold;font-style:italic">finobt</span>=0
<span style="color:#666;font-weight:bold;font-style:italic">data</span>     =                       <span style="color:#666;font-weight:bold;font-style:italic">bsize</span>=4096   <span style="color:#666;font-weight:bold;font-style:italic">blocks</span>=2620928, <span style="color:#666;font-weight:bold;font-style:italic">imaxpct</span>=<span style="color:#666;font-weight:bold;font-style:italic">25</span>
         =                       <span style="color:#666;font-weight:bold;font-style:italic">sunit</span>=0      <span style="color:#666;font-weight:bold;font-style:italic">swidth</span>=0 blks
<span style="color:#666;font-weight:bold;font-style:italic">naming</span>   =version 2              <span style="color:#666;font-weight:bold;font-style:italic">bsize</span>=4096   ascii-ci=0 <span style="color:#666;font-weight:bold;font-style:italic">ftype</span>=0
<span style="color:#666;font-weight:bold;font-style:italic">log</span>      =internal log           <span style="color:#666;font-weight:bold;font-style:italic">bsize</span>=4096   <span style="color:#666;font-weight:bold;font-style:italic">blocks</span>=2560, <span style="color:#666;font-weight:bold;font-style:italic">version</span>=<span style="color:#666;font-weight:bold;font-style:italic">2</span>
         =                       <span style="color:#666;font-weight:bold;font-style:italic">sectsz</span>=512   <span style="color:#666;font-weight:bold;font-style:italic">sunit</span>=0 blks, lazy-count=1
<span style="color:#666;font-weight:bold;font-style:italic">realtime</span> =none                   <span style="color:#666;font-weight:bold;font-style:italic">extsz</span>=4096   <span style="color:#666;font-weight:bold;font-style:italic">blocks</span>=0, <span style="color:#666;font-weight:bold;font-style:italic">rtextents</span>=0</code></pre></div>
<p>创建挂载点：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># mkdir -p /data/brick1</span></code></pre></div>
<p>将挂载信息写入<code>/etc/fstab</code>以便重启虚拟机之后能够自动挂载：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># echo &#39;/dev/sdb1 /data/brick1 xfs defaults 1 2&#39; &gt;&gt; /etc/fstab</span></code></pre></div>
<p>挂载分区：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># mount /dev/sdb1 /data/brick1</span></code></pre></div>
<h2 id="安装并配置glusterfs">安装并配置GlusterFS</h2>

<p>以下操作需要再所有节点上执行：</p>

<ol>
<li>安装GlusterFS：</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># yum install centos-release-gluster</span>
[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># yum install glusterfs-server</span></code></pre></div></li>

<li><p>启动GlusterFS管理进程，并查看进程状态：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># systemctl enable glusterd</span>
[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># systemctl start glusterd</span>
[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># systemctl status glusterd</span>
● glusterd.service - GlusterFS, a clustered file-system server
Loaded: loaded (/usr/lib/systemd/system/glusterd.service; disabled; vendor preset: disabled)
Active: active (running) since Tue 2018-01-09 11:40:59 UTC; 24s ago
Process: 12252 <span style="color:#666;font-weight:bold;font-style:italic">ExecStart</span>=/usr/sbin/glusterd -p /var/run/glusterd.pid --log-level <span style="color:#666;font-weight:bold;font-style:italic">$LOG_LEVEL</span> <span style="color:#666;font-weight:bold;font-style:italic">$GLUSTERD_OPTIONS</span> (<span style="color:#666;font-weight:bold;font-style:italic">code</span>=exited, <span style="color:#666;font-weight:bold;font-style:italic">status</span>=0/SUCCESS)
Main PID: 12253 (glusterd)
CGroup: /system.slice/glusterd.service
└─12253 /usr/sbin/glusterd -p /var/run/glusterd.pid --log-level INFO

Jan 09 11:40:59 gluster-node1 systemd[1]: Starting GlusterFS, a clustered file-system server...
Jan 09 11:40:59 gluster-node1 systemd[1]: Started GlusterFS, a clustered file-system server.
Jan 09 11:41:15 gluster-node1 systemd[1]: Started GlusterFS, a clustered file-system server.</code></pre></div>
<ol>
<li>配置防火墙</li>
</ol>

<p>各个节点上的gluster进程需要能够互相交流，为了简化配置，在每个节点上设置防火墙来接收来自其他节点的路由：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">iptables -I INPUT -p all -s &lt;ip-address&gt; -j ACCEPT</code></pre></div>
<p>在实际操作中将命令中的<ip-address>替换为其他节点的ip地址。</p></li>

<li><p>配置信任池</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gluster peer probe &lt;server-address&gt;</code></pre></div>
<p>这里的<server-address>可以是ip地址，也可以是hostname。当使用hostname时，需要先在/etc/hosts文件中配置好其他节点的ip地址和主机名。一旦信任池被建立，只有池中的成员可以添加新的服务器到信任池中。可以通过以下命令查看：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">gluster peer status</code></pre></div></li>

<li><p>设置GlusterFS卷</p>

<p>在每个节点上创建以下目录：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir -p /data/brick1/gv0</code></pre></div>
<p>在任意节点执行以下命令来创建、启动卷：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># gluster volume create gv0 replica 3 gluster-node1:/data/brick1/gv0 gluster-node2:/data/brick1/gv0 gluster-node3:/data/brick1/gv0</span>
volume create: gv0: success: please start the volume to access data
[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># gluster volume start gv0</span>
volume start: gv0: success</code></pre></div>
<p>上述创建卷的命令指定了卷的类型是&rdquo;replica&rdquo;，GlusterFS支持的卷有多种，其中有3种基础卷：</p>

<ul>
<li>Distributed - 分布卷：将不同的文件存储在卷中的不同块，适用于存储可动态扩展的环境。</li>
<li>Replicated - 复制卷：将文件复制到卷中的不同块，适用于高可用高稳定的环境。</li>
<li>Striped - 条状卷：将大文件拆分，分开存储文件不同的部分在卷中的不同块，适用于处理大文件的情况。</li>
</ul>

<p>其他卷的类型可以是以上3种基础卷的不同组合，详情可以查看<a href="http://docs.gluster.org/en/latest/Administrator%20Guide/Setting%20Up%20Volumes/">官方文档</a>。</p>

<p>确定卷已启动：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># gluster volume info</span>

Volume Name: gv0
Type: Replicate
Volume ID: 620f5f40-3bec-4c32-8f72-2d64debc8ae4
Status: Started
Snapshot Count: 0
Number of Bricks: 1 x <span style="color:#666;font-weight:bold;font-style:italic">3</span> = 3
Transport-type: tcp
Bricks:
Brick1: gluster-node1:/data/brick1/gv0
Brick2: gluster-node2:/data/brick1/gv0
Brick3: gluster-node3:/data/brick1/gv0
Options Reconfigured:
transport.address-family: inet
nfs.disable: on
performance.client-io-threads: off</code></pre></div>
<p>看到<code>Status: Started</code>字样，说明卷已经启动。</p>

<ol>
<li>测试GlusterFS卷</li>
</ol>

<p>在集群外的一台测试机上连接已经部署好的GlusterFS集群，需要先安装客户端软件：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@prometheus ~]<span style="color:#888;font-style:italic"># yum install -y gulsterfs glusterfs-fuse</span></code></pre></div>
<p>并且将GlusterFS集群各个节点的ip和hostname信息写入/etc/hosts文件：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@prometheus ~]<span style="color:#888;font-style:italic"># cat /etc/hosts</span>
127.0.0.1   prometheus  prometheus
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.12.101  gluster-node1
192.168.12.102  gluster-node2
192.168.12.103  gluster-node3</code></pre></div>
<p>挂载远程GlusterFS卷：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@prometheus ~]<span style="color:#888;font-style:italic"># mount -t glusterfs gluster-node1:/gv0 /mnt</span></code></pre></div>
<p>也可以选择挂载其他节点的卷，效果都一样。在/mnt文件夹中创建一个测试文件test.txt：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@prometheus mnt]<span style="color:#888;font-style:italic"># touch test.txt</span></code></pre></div>
<p>在GlusterFS集群的每个节点中，都应该能看到test.txt文件的存在：</p>

<p>gluster-node1节点：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node1 ~]<span style="color:#888;font-style:italic"># ls /data/brick1/gv0/</span>
test.txt</code></pre></div>
<p>gluster-node2节点：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node2 ~]<span style="color:#888;font-style:italic"># ls /data/brick1/gv0/</span>
test.txt</code></pre></div>
<p>gluster-node3节点：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[root@gluster-node3 ~]<span style="color:#888;font-style:italic"># ls /data/brick1/gv0/</span>
test.txt</code></pre></div></li>
</ol>

      </article>
  </div>
</section>

<aside>
    <h4 id="signature">
        Tue Jan 9, 2018
        
            cheon
        
    </h4>
    
    
    <ul class="tags">
      
        <li> <a href="https://www.cheon.site/blog/tags/fs">fs</a> </li>
      
    </ul>
    
    <ul class="related">
        
        <li><a class="previous" href="https://www.cheon.site/blog/struct/fluentd_config/"> Fluentd Config</a></li>
        
        
        <li><a class="next" href="https://www.cheon.site/blog/struct/ansible_variables/"> Ansible Variables</a></li>
        
    </ul>
</aside>

        </div><section id="footer">

<div id="author">
    <h2>About Author</h2>
    <hr>
    <img src=https://www.cheon.site/images/author.jpg></img>
    <p>Life is dance we all have to do.</p>
</div>
<ul id="link">
    <li><a href=https://github.com/number317/aloha.git target="_blank"><i class="fa fa-github" alt="github"></i></a></li>
    <li><a href="mailto:cheon0112358d@gmail.com?subject=blog%27s%20feedback" target="_blank"><i class="fa fa-envelope" alt="email"></i></a></li>
    <li id="wechat"><i class="fa fa-wechat"></i></li>
    <img class="qrcode" src=https://www.cheon.site/images/wechat.jpg>
</ul>
</section>
</body>
</html>
